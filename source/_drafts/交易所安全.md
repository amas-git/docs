# 交易所安全

## 1. 系统架构安全性

#### 1.1系统架构

图1显示了系统架构示意图，从图1可以看出整个系统最前端由系统防火墙组成，它主要

![img](https://lh5.googleusercontent.com/gw3riauumbgmBIZcXhtFCFX8cALsw0_yAdlIo35Npq9AzQiHfVe1rGadveBI7KiQtArqzM5UhAkihdg2z2UWjA6vHtp74qOrOQEfx_XH-FGTJRgOQ4GTPrQ5RTIrv3om1VhTbuHw)

图1  系统架构示意图

##### 1.架构说明

高性能优秀的服务架构，使得应用可通过高性能的 RPC 实现服务的输出和输入功能，可以和 Sping框架无缝集成

##### 2.主要核心部件

1. Remoting: 网络通信框架，实现了 sync-over-async 和request-response 消息机制
2. RPC: 一个远程过程调用的抽象，支持[负载均衡](https://baike.baidu.com/item/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1)、[容灾](https://baike.baidu.com/item/%E5%AE%B9%E7%81%BE)和[集群](https://baike.baidu.com/item/%E9%9B%86%E7%BE%A4)功能
3. Registry: 服务目录框架用于服务的注册和服务事件发布和订阅

##### 3.优势

1. 分布式服务框架，充分保证服务的高可用
2. 结构分离清晰，便于编码以及开发工作分工协作
3. 微服务化，模块间隔离清晰，便于系统安全以及开发重复利用
4. 数据异步化，保证应用高并发情况下稳定运行

#### 1.2 系统

![img](https://lh3.googleusercontent.com/vyPS0rflT9aWSRb0d4ckrXGWyCfxn-PBgObQjNW8Y7pRWc9C9izRJ866fkyIzQC5H3R9T_XK_c8EQFO7-_2twxVkjadj7YpfYlA3zzj4Zumofsu488vtTf2ZN2yleDf10yZmS0ET)

##### 1. 业务系统

| 系统名称             | 备注                                   |
| -------------------- | -------------------------------------- |
| 交易平台前端网关系统 | 对外向移动端，pc端提供API服务          |
| 订单服务             | 用户各币种下单，成交，结算             |
| 撮合系统             | 各个币种用户间达成交易                 |
| 神灯运营系统         | 工作人员日常运营系统                   |
| 钱包服务             | 数字货币保险柜, 向区块链广播交易       |
| 量化交易服务         | 交易所对第三方进行不同货币流转，对冲   |
| 交易数据计算服务     | 对前台行情，成交，盘面进行数据规整计算 |
| 账号系统             | 用户注册，登陆，认证，个人信息         |
| 账户系统             | 用户财产管理                           |
| 客服系统             | 客服人员工作系统                       |
| OPENAPI              | 对第三方厂商或大户提供交易接口         |

##### 2.平台支持系统

| 系统名称           | 备注说明                                                 |
| ------------------ | -------------------------------------------------------- |
| 日志收集服务       | 负责对所有业务系统日志进行归集存储                       |
| 风控系统           | 真对数据库数据和日志数据判定风险                         |
| 神灯数据系统       | 根据日志和数据库数据为工作人员提供精细化报表             |
| 财务对账系统       | 向财务提供用户资产，系统资产，资金流转等数据提供对账服务 |
| 报警系统           | 根据业务系统日志&数据监控向工作人员提供不同级别的报警    |
| 发布&环境部署系统  | 线上机器自动化发布与环境搭建系统                         |
| ERP审批流服务      | 内部工作人员或研发人员工作流程管理                       |
| 数据库操作审计系统 | 线上数据库操作系统规范记录系统                           |
| 系统配置中心       | 线上业务系统配置系统                                     |

#### 1.3 Web安全和渗透测试

FreeBuf黑客与极客,国内关注度最高的全球互联网安全媒体平台,同时也是爱好者们交流与分享安全技术的最佳社区。FreeBuf目前全球网站排名8113远超国际著名众测网站hackerone(全球排名:60200). FreeBuf旗下的漏洞盒子是一个独立的第三方机构，是目前国内最权威的众测平台，通过在平台上认证的众多白帽子来帮助企业发现安全漏洞，企业为漏洞发掘者提供适当的回报，项目自发布后任何人不得更改。同时每一个漏洞状态、厂商的处理方式及流向，都能在平台中清晰呈现。漏洞盒目前所服务的企业非常广泛，包括:

- 支付宝
- 腾讯
- 小米
- 索尼
- 三星
- 联想
- IBM
- 中国移动

在Bitrue的授权下，漏洞盒子上众多的白帽子模拟真实的黑客，针对Bitrue发起了多种类型的入侵尝试。最终证明Bitrue的安全等级下，可以保证在全球范围内应用程序不会受到OWASP（开放式WEB应用安全项目/Open Web Application Security Project）危害前10中所列出问题的影响。包括但不限于:

1. 注入
2. 失效的身份认证和会话管理
3. 跨站脚本（XSS）
4. 不安全的直接对象引用
5. 安全配置错误
6. 敏感信息泄漏
7. 攻击检测与防护不足(新增)
8. 跨站请求伪造（CSRF）
9. 使用含有已知漏洞的组件
10. 未受有效保护的API

## 2.   系统风险管理步骤

### 2.1  系统风险定义

交易所系统的风险按按种类可分为系统运行环境风险、人为风险；

系统运行环境风险：交易所主要部署在亚马逊aws云服务中。aws故障将是此类风险主要原因。此类风险产生的原因很多，比如硬件故障，常见的有磁盘满，硬盘故障等；机房故障，常见的有机房停电，机房网络设备故障等；公网故障：比如海底电缆被挖断，导致整个区域的用户无法访问某机房的服务；灾害：例如火灾、地震、海啸等不可抗拒的灾害给机房所在地带来的破坏；政治经济因素：因政局不稳定或贸易战导致无法继续使用云服务。

人为风险：此风险分为内部风险和外部风险。内部风险主要来自内部开发、运维人员主、客观造成的各项故障；外部风险则主要来自于黑客攻击。此外，一些情况下用户集中访问系统带来的峰值，也可能给系统造成故障；

 ### 2.2 理风险标准流程

![img](https://lh5.googleusercontent.com/roCXGDUl9tPHL844PTajABmKQYUMAQ2kltsTraWVoQg-XIlCj5BmWc1aMYe-a4fUnQXGX1zvoH9LfaZ66N6DBNQvARX_a9IiRCONfa3dEnaCCIwZAyeZd-cSpqCeIVwIoDg_3J3E)

上图是就对大多数系统运行环境风险、人为风险的标准流程。

首先：『风险采集层』通过各种监控系统、客服人员以及第三方安全网站，比如乌云，能捕捉绝大多数系统的异常情况。尤其是监控系统，如果设置得当，大到地震海啸、小到内部员工监守自盗，都能及时发现。

监控系统发现的异常情况，通过短信或邮件将报警发送给相关负责人。通常，收到报警的人要进行故障的初步判断。如果报警出自自己负责的系统，必须第一时间进行相应的处理。这时，若干个与该报警相关的人员已经在早已经创建或临时创建的保障群里针对此故障进行交流。与是，问题信息到达『风险定位层』。

对于一些责任明确、严重级别较低的问题，可直接委派最终处理人，此时的故障负责人就是问题跟进负责人；如果问题涉及多个部门，需要协调解决，则需委任问题跟进负责人全权协调；对于非常严重的问题，问题跟进负责人则需要请示公司高层定夺，由公司高层给出决策意见。

在风险处理层，也就是问题的最终处理节点，故障负责人要及时处理问题，反馈处理进度。

## 4.   安全管理流程

### 4.1   信息安全的管理流程

- 建立广泛的用户沟通渠道，包含但不限于Telegram、Email、Slack等，对于发现信息安全漏洞的使用者给予激励，提高信息反馈的积极性。

- 让员工成为信息安全的管理过程的一部分，让员工成为查找风险和应对措施的积极分子，投入到整个过程和计划中，同时也在这个过程中教育企业中的每一个人。

- 对涉及信息安全的信息进行分级，对通等级的信息实行不同级别的管理措施。

- 公司安全组不间断的对公司开放信息进行安全扫描，内容分析，对敏感信息进行预警和处理。

- 不间断使用第三方安全扫描服务，针对敏感信息进行告警通知。
- 针对交易所业务特点，对交易所中业务中的机密数据,对其接收、存储、传输、和访问的方式设法保护。
- 为灾难做好规划，做好关键服务的容灾，不同机房间的容灾，异地容灾，服务商间的容灾。

我们通过评估自己的安全计划，长期做安全监视和定期做安全演练，建立自己的内审团队，在要求审计之前自己先执行审计，以便找到漏洞，从而不断完善自己的计划。

### 4.2   网络安全的管理流程

  - 针对用户端和服务端通信采用基于时间和HMAC, SHA256等单项签名等世界公认的签名机制，确保信息的完整性、可控性、不可否认性及可用性，防止伪造非法请求，获得交易所正常服务。
  - 针对网络中异常的网络冲击，具有针对IP及用户等要素的多种限流策略，确保合法请求及时响应，非法请求得到准确拦截。
  - 针对交易所外部网络和内网服务器间建立安全防火墙，对外提供服务的服务器与互联网之间隔离；在交易所内部建立内部安全防火墙，内部服务器间进行安全隔离。
  - 在不同区域间建立机房集群和陈余备份，在不同区域网络异常下，自动切换到正常网络，保证网络服务的正常可用。在同一区域的不同机房间建立集群及陈余备份，保证区域内网络的通畅和服务正常可用。
  - 针对交易所服务的静态资源，使用遍布全球上万数据节点进行内容分发，确保网络服务急速响应。
  - 网络服务完全使用防劫持、防篡改、防泄漏的企业级HTTPS加速服务，使用refer防盗链、UA防盗链、IP防盗链、URL鉴权校验等多重防盗链的访问控制功能。
  - 定期进行网络安全评估，不间断进行渗透测试、安全扫描、代码安全审计、网站安全监测。



通过网络安全舆情监测、内审网络安全审计，内部及第三方安全扫描，对安全风险进行安全排查及处理，并技术和业务评级，快速响应。通过日志系统等监控系统排查安全影响，是其影响降到最低。针对相似风险，进行横向排查，杜绝其他访问相同的风险发生。

​      

## 5.   安全事态追踪

### 5.1 安全事态追踪和处理

##### 1.安全事态追踪

项目内部漏洞

我们有内部完全独立的安全研发团队，在项目上线前会内部安全渗透测试，漏洞扫描；关键项目还会外加一轮第三方安全厂商安全测试（绿盟，Mcafee,IBM）

针对线上已经存在的项目，经过我们内部的运行日志，线上服务监控等手段&数据收集到数据系统，能够快速发现漏洞并告知及时处理

行业安全，实时关注系统软件官方升级消息，同时在各大白帽子网站购买安全舆情信息；及时掌握行业安全信息，防患于未然；未来我们将会搭建自己的安全舆情平台，第一时间掌握行业安全信息

##### 2.安全事态分析

根据暴漏出来的安全事件，结合漏洞信息、资产信息、告警策略信息等，分析告警事件与资产之间的关联关系，告警事件与漏洞之间的关联关系，利用网络安全指标体系计算网络风险值，发现高风险事件，高风险资产，并对整体威胁告警情况进行自动调整。

 针对分析发现的可疑威胁源与高风险事件，进行持续跟踪分析， 并结合历史告警事件进行关联分析，挖掘隐藏的真正威胁，发现长期持续的攻击行为。告警处理以工单派发的形式通知告警处理人员，告警处置为告警分析专家提供调整告警级别的功能，告警处理完成后提交告警处理记录，支持设置策略自动处理告警事件。

##### 3.安全事态应对流程

![img](https://lh5.googleusercontent.com/XM85uOW1RKSpPbTYm3nY-9W5A7BZIKyR9JwDnKzr_Nt_XFkVRKtVL7y8JjMtEgqVW-9wR1-J7ZFqSTCfu4Q4YDHD-CdvN7uoLmp6MNNJhKYxA2E6_QS2lOzrvPtiw48z9PT7tr2D)

## 6.   开发流程

## 6.1 系统开发流程

![img](https://lh3.googleusercontent.com/A3wIS4V7ySuk0wenC0aYb0eXFkK_b_Zt02KUtxf-ptoRiuYNKc60IeeWU47rN4nUin9OCD-bNllqzkamHgJ8JAwVqcow1q0zhXFvMigxD9V2mYubn4u30XPbAzo8GR_MLx4MGA2d)

## 6.2 统质量评定标准及其上线评定标准

上线需通过整体回归测试并符合以下标准

| P1   | P2   | P3   | P4   | P5 (建议)  |
| ---- | ---- | ---- | ---- | ---------- |
| 无   | 无   | ≤ 1% | ≤ 4% | 暂不作要求 |

若不符合标准则不允许上线。

各级缺陷定义如下

### P1 - 严重缺陷，包括但不限於

1. 死循环
2. 数据库发生死锁
3. 因错误操作导致服务中断
4. 与数据库连接错误
5. 数据通讯错误
6. 功能错误
7. 数据计算错误

### P2 - 较严重缺陷，包括但不限於

1. 功能不符
2. 数据流错误
3. 接口错误
4. 数据库的表、业务规则、缺省值未加完整性等约束条件

### P3 - 一般性错误，包括但不限於

1. 界面错误
2. 简易性输入限制未在前端进行控制
3. 撤销操作未给出提示

### P4 - 轻微错误，包括但不限於

1. 说明不清楚
2. 显示格式不规范
3. 长时间操作未给用户进度提示
4. 可输入区域和只读区域没有明显区分提示
5. 系统处理未优化

### P5 - 测试建议(非缺陷)

改善性建议, 不影响产品使用.

## 7.   安全运营细则

### 7.1   开发管理流程

Test Driven Development(TDD)

TDD要求开发人员在写代码前，先写好测试用例，再编写代码，并且代码能够通过测试用例。随着不断地迭代和重构，测试用例的数量和覆盖点也会不断增加，程序所实现的功能也越来越复杂。开发人员需要不断提高单元测试的覆盖率，以此来增强代码的可用性。

![img](https://lh4.googleusercontent.com/O9ymPFvpMlz_DSGQ1xzEt20r5FpJtWPWYmsELIfAwyXrf1VcCqD3mjB6UY1aEMpvVzi2ODPePaL2O89XUvTgqqhqIZ2_NVEm83l534kd4csfWe2CoIej4bIYwI3Nair5r3B0_GnA)

### 7.2   编程规范

统一代码格式管理,确保在各操作系统,各IDE下代码的格式一致;

采用sonar进行静态代码检查;

定期组织代码review;

### 7.3   性能保证计划

发布到FAT/UAT环境后,进行接口压力测试, 压测通过后在线上环境通过开关进行灰度发布,保证新功能上线不会影响现有功能;

### 7.4   测试规范

在开发人员完成自测后,根据提测模板进行提测:

- 提测模板包括项目/模块版本号;

- 自测情况;

- 开发人员测试建议

- 测试人员case列表以及各case流程图

### 7.5   安全编程规范

- 过滤用户提交数据中的HTML代码

- 限制用户提交数据长度

- 禁止通过接口触发反射

- SQL操作使用PreparedStatement,并过滤特殊字符,防止SQL注入

### 7.6   代码提交规范

通过Jira+gitlab对git操作进行权限控制

- QA人员通过JIRA分配分支编号并新建git分支

- 开发人员可以在相应分支上进行开发、修改

- 开发完成后由QA人员验收之后合并主干

- 修改JIRA项目状态结束当前版本开发

### 7.7   安全上线流程

![img](https://lh4.googleusercontent.com/o7zrc8nCVCBSOLtWaVlF1gdm73cG9T1a0HgffXdb6LHnLq8JBT704NeD09Y57kY76xGFUg7yqIpypiXrphHwfNMhnKvLzDlFyiqVkFRi3U4ZtOyi04e_mQJ9H0FsCRCZQ7Noh2rg)

### 7.8   使用aws的风险评估及其防范

### 7.9   API的提供目的及其设计

为了支撑PC端、移动端、开发者多终端接入的交易所核心服务系统，以应对业务的快速变化，保证基础服务的稳定性和健壮性，同时也方便做市商及大客户的大批量、急速交易，交易所提供了丰富的API。

 在API的架构设计上采用多层安全纵深涉及，形成安全漏斗，对多变的安全威胁通过快速增加过滤层进行拦截，保护核心业务的安全，稳定。同时对于各种操作和访问，日志系统记录痕迹，对于风险操作风控系统和业务系统全程跟踪，一旦越过阈值，报警系统通知相关人员并自动处理。

API采用分布式集群模式，单机服务的宕机不影响整体业务提供服务，并在业务流量突增下，能够快速横向扩展，提高服务支持容量。

![img](https://lh6.googleusercontent.com/43pQ-zx4UTZlpnISSptKjMGF9RqgyYCOMGVXbWB_SadwL7_iw2uv6AZttyCOeQN0LXfctE7haUqYKyj9As0oA1CmfAAuLvw66W2pCNxh78TXxMkPMAX95FtAsIob3kdW_pbFDIYN)

### 7.10  API的风险评估及其风险防范

#### 1. 自研防DDOS攻击防火墙

 依据用户请求行为，与频次在nginx上嵌入自研防火墙程序，当遭遇攻击或用户访问过于频繁时，系统自动跳转到人机验证服务，验证通过才可以正常进行访问；

#### 2. 程序本身基于基于IP防护策略

 程序设计本身最外层做有一套分布式访问过滤，针对用户请求IP，查询，操作等行为，分别设定相同IP最大访问限量，并会基于历史数据，根据忙时、闲时自动调整；

#### 3. 程序本身基于用户的防护策略

程序设计本身最外层做有一套分布式访问过滤，真对用户登陆状态，查询，操作，交易等行为，不同接口配置不同安全策略，并会基于历史数据，根据忙时、闲时自动调整；

#### 3. 架构异步防止用户请求穿透

系统架构所有数据库操作，查询都采用异步，分离处理，当用户发起请求查询或者操作时首先能够接触到的都是各级缓存，严格控制用户直接接触到数据库，有效防止直接对持久化数据库产生攻击，保证没有拖库风险；

#### 4. 数据严格格式化处理防注入

系统架构层面独立数据库操作统一安全策略；相关操作采用PDO，严格模式执行，对接口提交参数进行格式校验，合法性校验，转译处理等操作防范注入攻击

数据库层面，对用户核心资产，用户隐私数据，密码，等相关核心数据进行加密存储，降低泄漏或者其他丢失风险

#### 6. 线上业务报错不对外公布，防止核心信息泄漏

线上项目对于错误级别输出，系统配置错误级别严格把控；区分生产模式与调试模式，调试模式只真对运维内部以及内网开放，切错误只通过日志形式透漏；

#### 7. 代码扫描

上线发布之前进行代码扫描，保证代码输出规范



## 8.   故障和灾备处理流程

### 8.1   故障处理流程

![img](https://lh4.googleusercontent.com/zWXLAJkyD53pHQwFDoJQaRPknLvYu7fXQCr7iX5sJ59WHR7Jt0qvyGWccEYvzO3zeXmlNQ7nk8C2TTVbyL_LPGCezUh_fKvUVYK51e6qUTo-Z-wdzv2LX-NnAA1GJukvD5fAu0CM)

### 8.2   故障原因分析及其预防

-  故障发生时，如果负责人不在电脑旁边，可先看报警短信，评估故障的严重程度，能做到初步推测故障原因。

- 集群报警还是单机报警，如果是单机报警，那么报警机器比总是多少

- 报警影响范围，是某个API报警，还是某个类目API还是整个平台级别的

- 方向判断，db报警、宿主机报警、load报警，网关报警、磁盘报警，如果方向明确可以联系相关同学。

- 报警趋势，报警机器增加还是减少，报警值增加还是减少了。

- 经过初步判断以后，一般可以定位到具体故障机器。这时，获取故障机器的第一手材料是非常有效的排查故障的手段。

- 重点关注性能指标
  - load
  - gc
  - qps
  - rt
  - io
  - cpu
  - memory
  - swap
  - tcp connection numbers
  - network throughput
  - response delay time

 

 很多故障都是系统发布导致的，关注发布过程是至关重要的事情。

| 注意事项 | 详情                                                         |
| -------- | ------------------------------------------------------------ |
| 代码评估 | 发布前，建议快速review代码修改点，整个修改能带来什么风险，有做到心里有数 |
| 发布过程 | 基础系统需要Beta发布和分批发布。                             |
| 系统观察 | 关键性能指标(load,cpu,memory ... )                           |

 

除了上述系统指标，对重点业务数据进行监控也是预防故障的必要手段：比如对交易量、取现请求等，可根据日常经验值设置预警阀值，从而达到访问量异常时的预警。

最重要的是要对整个系统有全局的了解，掌握各节点的依赖关系，对核心链路的容量进行评估，在此基础上对关键节点做好监控、性能调节开关等故障应急手段。平时多进行全渠道压力测试，尽早发现系统的故障和瓶颈。

### 8.3   故障原始日志管理

- 线上机器保存近一个月的日志
- 一个月以前的日志单独备份
- 所有日志同步到ELK集群, 方便检索查阅

### 8.4   故障发生的数据和任务恢复

- 保存内存和线程,垃圾收集等关键信息
- 通过jstat -gcutil pid 来查看机器gc的实时情况
- 通过sar命令获取网络相关数据
- 通过free、vmstat获取内存信息
- 通过top、mpstat获取cpu数据
- 对于系统性能造成的故障，采用分流或功能降级的临时应对方案。事后，再根据具体瓶颈点进行优化
- 对于程序BUG造成的故障，严重的应该立即停止服务提供，待bug修复再重新提供

### 8.5 数据&服务灾备

![img](https://lh5.googleusercontent.com/pH8VSUPlZAIgP8nbyRQQ1s_D-SRHWc8ItA2SXuHYWEoksToH9058_55DuTq_Fzk0POVTcULmnsL2Xx3mudaTJIOu_hn4XINLxPXqvoY0WlgwE35FNwVLjoM4AbojfiCpuckubHX-)

## 

## 9.   钱包流转设计和安全防范

### 9.1   区块链交易服务器构造

![img](https://lh4.googleusercontent.com/Jjkkms72UZPqmg7IbCxlw1VNhTgu96o6yDi7X_In_aLIojy4zb6t_wdzKWZ6uQYZbbJcmf22rcwn7ZPlrKeJ8cPO2y-ozbBZi-nKvO6wXPeZet95hTRAxKDbXVHVMvhw849ilE3k)

- Bitrue  Exchange: 交易所服务系统
- Risk Control: 风控系统
- Assets Manager: 资产管理系统, 及时将交易所资产保存到冷钱包
- Keystore Manager: 用户私钥及地址生成
- Exchange Monitor: 交易所提现任务监控
- BlockChain Monitor: 区块链充值交易监控
- Ir Clipher: 加解密服务
- Tx Maker: 生成交易并签名发送

### 9.2   区块链交易设计

- 采用钱包节点分离的策略

- 钱包机用于生成交易并进行签名

- 签名后的交易由节点机广播到区块链
- 钱包不断监控交易被处理的情况，当交易被认为足够可靠的时候通知交易所提现或者充值成功。

### 9.3   钱包管理状况

1. 冷钱包由核心人员掌握, 不触网. 有备份.
2. 热钱包数据库以及私钥均至少经过AES256加密, 数据异地备份.
3. 热钱包只保存10%的资产

### 9.4   钱包私钥管理状况

名词解释

| 名词         | 定义                           |
| ------------ | ------------------------------ |
| 密钥         | 一串随机数字                   |
| 冷钱包       | 不接触网络的钱包叫冷钱包       |
| 冷钱包密钥   | 保存于冷钱包的密钥             |
| 系统钱包     | 交易所用于支付用户提现的钱包   |
| 系统钱包密钥 | 交易所系统钱包中的密钥         |
| 用户钱包     | 交易所为用户开设用于充值的钱包 |
| 用户钱包密钥 | 用户钱包中的密钥               |

#### 9.4.1 密钥保护和密钥分级

交易所根据密钥(或账户)的用途进行分级, 0级为最高级别, 1级次之,以此类推. 对于不同级别的密钥采用不同的管理方法.

| 名称         | 等级 | 用途                      |
| ------------ | ---- | ------------------------- |
| 冷钱包密钥   | 0    | 保管交易所核心资产        |
| 系统钱包密钥 | 1    | 资金归集,向用户支付提现金 |
| 用户钱包密钥 | 2    | 用户充值                  |

#### 9.4.2 安全策略

- 利益相关人掌握, 利益相关人数为N,
- 冷钱包私钥由交易所利益相关人保管
- 交易所钱包程序掌握
- 硬件钱包备份:  Ledger Nano S
- 纸钱包备份: 印刷品, 加密保存
- 多重加密: 多种加密方式混合,  通常由AES和异或组合而成
- 加密算法随机化: 加密算法, 加密算法组合方法,以及 加密算法的参数由程序生成并且加密存储
- 地址加密
- 地址在数据库中是经过加密的用于隐藏对应关系, 即便数据库泄露也很难与区块链上的资产建立关联
- 数据库加密
- 采用AWS的加密数据库
- 硬盘数据备份
- 多机房
- 异地备份

| 策略                   | 0    | 1    | 2    |
| ---------------------- | ---- | ---- | ---- |
| 利益相关人员掌握       | 是   | 否   | 否   |
| 交易所钱包程序维护掌握 | 否   | 是   | 是   |
| 地址加密               | 是   | 是   | 是   |
| 密钥加密               | 是   | 是   | 是   |
| 硬件钱包备份           | 是   | 否   | 否   |
| 纸钱包备份             | 是   | 否   | 否   |
| 数据库加密             | 否   | 是   | 是   |
| 加密算法随机化         | 否   | 是   | 是   |
| 硬盘数据备份           | 否   | 是   | 是   |

#### 9.4.3 运维规范

1. 运维自动化, 部署自动化,运维无法接触源码
2. 加密规则由程序随机生成
3. 开发人员不能接触正式环境,无法获取加密规则以及密码
4. 代码发布需经过严格审计
5. 运维系统具备审查功能, 针对运维帐号的所有操作均加以记录,

### 9.5   在网络攻击下，如何保证用户资产

1. 对于一些恶意的交易有可能给客户带来损失的, 通过风控系统发现并及时作出响应
2. 整个交易所系统在IT层面上的安全防护这是第一道屏障
3. 如果窃取数据库, 首先数据库是经过加密的, 这是第二层防范
4. 即便获得了数据库中的内容, 私钥等核心数据是经过AES加密的, 只有进一步获取加密规则才可能获得真实的私钥这是第三层防护
5. 90%的资金保存在不触网的安全环境中, 也就是用户的绝大部分资产都在网络环境之外.

#### 9.5.1 提现风险控制

功能层面提供给用户灵活可靠的安全策略, 包括:

| 产品安全策略           |                                 |
| ---------------------- | ------------------------------- |
| 资金密码               | 提现时必要,交易时可选           |
| 谷歌二步验证           | 提现时必要,登录时必要           |
| 邮箱/短信验证          | 提现时必要,登录时必要           |
| 自定义提现地址白名单   | 提现时可选                      |
| 自定义每日提现最高额度 | 提现时可选, 默认额度1w美金/每日 |



提现时风控系统把关:

| 检查项                                  | 未通过处理方法         |
| --------------------------------------- | ---------------------- |
| 是否有充值                              | 拒绝提现               |
| 近三天的充值是否真实有效(TxAge满足要求) | 拒绝提现, 转人审       |
| 是否是用户常用IP                        | 短信通知用户, 转人审   |
| 是否是常用的提现地址                    | 短信通知用户, 转人审   |
| 转账地址是否在用户的白名单              | 短信通知用户, 拒绝提现 |
| 是否超过用户的单日提现最高额度          | 短信通知用户, 拒绝提现 |
| 提现地址是否为黑地址                    | 拒绝提现               |
| 当前帐号是否存在违规行为                | 拒绝提现, 转人审       |
| 关联帐号中是否有加黑帐号                | 拒绝提现, 转人审       |
| 用户资产回归正确                        | 拒绝提现, 转人审       |



### 9.6  冷热钱包

> 冷钱包: 不触网的钱包
>
> 热钱包: 能够接触到网络的钱包

交易所一方面要提供7x24小时的在线交易服务, 一方面又要保存大量的用户数字资产. 如果将所有的用户资产放在可以接触到网络的环境下, 是非常危险的. 因此我们的钱包会将一定比例的资金转移到安全的冷钱包中. 将鸡蛋分散在多个篮子中, 再把篮子锁到保险柜中. 最大程度的分散风险.



### 9.7  防范51%攻击和虚假充值

区块链技术革命性的建立了数字信任, 但并不是万无一失. 区中心化并不等于绝对安全. 在基于POW的区中心化加密货币技术中存在中心化的可能, 基于POW的加密数字货币(如比特币, 以太坊)等, 非常依赖矿工的参与, 矿工有记账的权限, 也就有篡改账本的可能, 这种攻击成功的概率与恶意矿工所掌握的算力有关. 

![](/home/amas/2019-03-15-173220_763x849_scrot.png)

对于数字资产充值到交易所, 通常的做法是等到充值交易在区块链上获得足够多的确认即认为充值完成. 这样的做法具有一定的风险, 

1. 黑客在充值完成后发起51%攻击, 在区块链上清空之前的交易. 
2. 黑客利用区块链的漏洞或是交易所钱包的漏洞进行虚假充值

应对的方法有3,需要对充值的有效性进行持续的确认, 

1. 要在普通意义上的充值完成后对充值交易的有效性进行持续的检查, 
2. 对于交易的有效性, 要从第三方节点/区块链浏览器进行校验, 
3. 从账户金额增长的维度核验充值交易是否有效, 交易所一段时间内的资产变化必须与用户的实际充值金额相等, 否则就是出现了虚假充值.

通过以上三种方法, 我们可以做到有效的抵御区块链遭受攻击给交易所带来的损失.

| 一般交易所做法                    | Bitrue                                           |
| --------------------------------- | ------------------------------------------------ |
| 仅在自有节点上进行交易确认        | 自有节点, 第三方节点, 第三方区块链浏览器多维确认 |
| 充值达到一定确认后即完成,不再追踪 | 对每一笔充值有3天的跟踪时间, 充分保证交易不可逆  |
| 仅确认交易真实有效                | 从交易和账户余额两方面验证                       |

交易所的传动做法是以确认数作为交易可靠程度的依据, 通常达到要求的确认数需要一定的时间. 如果时间太长则用户等充值到帐的时间太久, 如果太短, 则交易所面临51%攻击交易回滚导致损失的概率增大. 为了解决这一问题, 我们采用了不同的交易可靠单位度量. 我们以一笔交易在区块链上的年龄(TxAge)作为可靠性的判断.

> TxAge = Tx最近一次核验时间 - Tx上块时间

我们会在用户提现的时候, 重新计算每笔交易的TxAge, 对于不同的充值金额要不同的要求.

## 10 风控系统

为了保证整个交易所的业务正常安全的运转.  风控系统7*24小时严密监控交易所中发生的事情,

- 微观层面, 风控系统能够监控用户的任何操作,
- 宏观层面, 风控系统要监控各种业务指标是否有异常波动(如: 是否有大量用户抛售或买入某个币等行为).   
- 风控系统对用户行为的记录亦方便日后调查取证

### 10.1 风控系统架构

总览:

![](/home/amas/2019-03-15-184143_856x372_scrot.png)

1. 风控系统与交易所系统网络隔离, 使得两部分系统不受影响, 同时增加了入侵成本.
2. 仅通过必要的风控接口进行交互
   1. 风控系统发现问题后可采取必要的行动, 包括
      1. 发送报警短信/微信/邮件
      2. 冻结用户登录
      3. 冻结用户提现
      4. 冻结用户交易
      5. 终止钱包业务
3. 风控系统是准实时系统, 采用pipline架构. 

技术架构:

![](/home/amas/2019-03-15-195259_577x346_scrot.png)



1. 数据同步系统需要实时同步交易所业务数据从库集群
2. 同步过来的数据清洗规格化之后进入风控系统的本地数据库(leveldb)
3. 利用图数据库(levelgraph)将用户特征的联系建立并保存起来, 用于关联分析和黑特征标记.
4. 事件定义系统根据数据的变化产生事件, 如用户充值事件, 用户登录事件等
5. 事件路由到决策引擎, 由决策引擎进行对应的处理
6. 产生的事件最终保存到ELK集群中, 用于备份和检索, 取证.
7. Dashboard提供风控系统运行的实时状态, 同时通过Dashboard可定事件,以及修改决策引擎的规则.
8. 区块链核验系统, 不间断从第三方节点, 区块链浏览器验证交易的有效性.
9. 主动探测系统会主动探测用户的设备是否具有危险属性

### 10.2 风险特征标记

风控系统对于不良账户的特征可以进行标记, 即使恶意用户更换帐号, 我们仍然可以通过设备, 网络,提现地址等特征分析出是存在问题的用户. 并进行关注和处理.  

### 10.3用户盈亏监控

短时间内资产大幅增长或亏损情况, 对于盈利和亏损极大的用户进行人工审核. 

### 10.4 防范三角套利用户

1. 通常量化交易用户使用的是量化交易API, 我们针对API用户有更加严格的控制
2. 非API交易用户交易频率过高, 每分钟超过30次或每秒超过2次的交易者会被系统识别

### 10.5 防范羊毛党

作为交易所, 日常的运营以及活动都是帮助业务良性的增长, 找到目标用户. 实现双赢. 羊毛党利用自己的技术以及资源, 已经成为电商, 交易所等业务的

1. 一方面提高活动的门坎要求用户绑定手机邮箱等
2. 在运营过程中通过自动和人工识别羊毛党, 并对羊毛党特征进行标记和记忆.
3. 风控系统会监控羊毛党,  不予参加活动.
4. 对于用户ip进行主动探测, 如果发现用户设备开启了80,443等端口, 则标记为开发设备, 非常有可能是羊毛党或黑客
5. 一经发现, 和帐号相关的IP, 设备, 提现以及充值地址都将被标记, 如果发现任一特征, 羊毛党无法逃过风控系统. 除非更换或伪造设备, 更换充值提现地址, 

### 10.7 记录帐号操作

风控系统可以实时监控用户的行为, 包括但不限于

- 登录
  - 登录次数频率
  - 登录失败次数, 频率
  - 常用登录国家/地区
- 充值
  - 充值地址共用情况
  - 常用充值地址
  - 三方地址黑库检测
- 交易
  - 交易次数频率
  - 套利行为分析
  - 非法高频交易分析(使用非API手段进行高频交易)
  - 用户撤单次数, 撤单频率
- 提现
  - 提现地址共用情况
  - 常用提现地址
  - 三方地址黑库检测
- 参与活动
  - 参加活动的次数
  - 参加活动的奖金

同时风控系统会综合用户其他相关的数据来形成用户画像, 包括但不限于

- 手机相关的信息
  - Bitrue设备ID(隐藏在手机系统中的用户唯一标识)
  - 设备指纹
  - 第三方应用ID(AFID, GAID, FireBase ID)等
  - 设备操作系统特征
  - 是否为模拟器
  - 是否为root手机

- 用户网络相关信息
  - IP
    - IP共用人数
    - 网段共用人数
  - 网络运营商
  - 网络所在的位置
- 用户区块链信息
  - 地址关系分析
  - 交易三方有效性检查
  - 资金流向分析

### 10.8  账户关联分析

用户可能持有多个帐号, 通常这些帐号都是用于正常使用的. 但是在一些特殊场合, 比如羊毛党可能持有大量帐号. 以此来获利. 风控系统可以追踪帐号和帐号之间的关联程度. 从而识别出多个帐号是否是相同的人. 对于有过恶意行为的人即便更换帐号我们也会记录特征. 加入风控名单. 即使更换帐号, 也可以最大程度的识别加以预防.

## 11 用户隐私数据的保护

风控系统使用的很多数据具有一定的隐私性, 一方面这些信息有助于风控系统对用户加以保护. 另一方面使用这些数据的时候又应当避免泄漏.

1. 对数据进行脱敏处理,
2. 尽可能采用SHA1, BCRYPT等安全低碰撞的Hash算法提取数据特征, 避免直接使用敏感数据
3. 在架构上风控系统置于内网, 与交易隔离, 仅保留必要的控制接口, 降低外网攻击的可能性
4. 内部数据库采用加密存储, 避免内部泄密

